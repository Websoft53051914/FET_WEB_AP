@{
    var mapAttr = new
    {
        IdModal = ViewData["TreeModalId"],
        IdBtnOk = Guid.NewGuid(),
    };
    var EventName = ViewData["EventName"];
}

<div class="modal fade max100vh" id="@mapAttr.IdModal" tabindex="-1" role="dialog" aria-labelledby="@mapAttr.IdModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5>維修品項</h5>
                <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="tree"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="button" id="@mapAttr.IdBtnOk">確認</button>
            </div>
        </div>
    </div>
</div>

<script>

    $('#tree').jstree({
        core: {
            data: [
                {
                    "id": "r",
                    "parent": "#",
                    "text": "報修品項",
                    "state": { "opened": true }
                },
                {
                    "id": "r1",
                    "parent": "r",
                    "text": "保全"
                },
                {
                    "id": "r1-1",
                    "parent": "r1",
                    "text": "保全系統"
                },
                { "id": "r1-1-1", "parent": "r1-1", "text": "保全主機" },
                { "id": "r1-1-2", "parent": "r1-1", "text": "保全卡" },
                { "id": "r1-1-3", "parent": "r1-1", "text": "玻璃破碎感知器" },
                { "id": "r1-1-4", "parent": "r1-1", "text": "磁簧感知器" },
                { "id": "r1-1-5", "parent": "r1-1", "text": "空間感知器" },
                { "id": "r1-1-6", "parent": "r1-1", "text": "緊急押扣" },
                { "id": "r1-1-7", "parent": "r1-1", "text": "金庫感知器" },
                { "id": "r1-1-8", "parent": "r1-1", "text": "護欄周圍感知器" },

                { "id": "r1-2", "parent": "r1", "text": "商品保全" },
                { "id": "r1-3", "parent": "r1", "text": "監視系統" },
                { "id": "r1-4", "parent": "r1", "text": "系統測試" },

                { "id": "r2", "parent": "r", "text": "停車區域設備" },
                { "id": "r3", "parent": "r", "text": "傢俱設備" },
                { "id": "r4", "parent": "r", "text": "小型設備" },
                { "id": "r5", "parent": "r", "text": "影音設備" },
                { "id": "r6", "parent": "r", "text": "招牌設備" },
                { "id": "r7", "parent": "r", "text": "機電設備" },
                { "id": "r8", "parent": "r", "text": "直營取叫號機" },
                { "id": "r9", "parent": "r", "text": "空調設備" },
                { "id": "r10", "parent": "r", "text": "裝潢設備" },
                { "id": "r11", "parent": "r", "text": "門市多媒體設備" },
                { "id": "r11-1", "parent": "r11", "text": "測試" }
            ]
            ,
            multiple: false,
            plugins: ['checkbox'],
            checkbox: {
                three_state: false,  // 不要自動勾選父節點
                cascade: ''           // 不連動子節點勾選
            }
        }
    });

    $('#tree').on("select_node.jstree", function (e, data) {
        console.log("選取節點 ID:", data.node.id);
    });
  

    $("#@mapAttr.IdBtnOk").on("click",function(){
        let data = {};
        var selectedNodes = $('#tree').jstree("get_selected", true);
        if (selectedNodes.length > 0) {
            var selectedText = selectedNodes.map(function(node) {
                return node.text;
            }).join(", ");
            data.selectedItem = selectedNodes[0].id; // 取得選中的節點 ID
            data.selectedItemText = selectedText; // 取得選中的節點文本
        } else{
            data.selectedItem = null; // 沒有選中節點
            data.selectedItemText = ""; // 沒有選中節點文本
        }
       //觸發自定義事件，傳遞選中的品項
        $(document).trigger("@Html.Raw(EventName)",data);
        $('#@mapAttr.IdModal').modal('hide'); // 關閉模態框
    })
</script>