@{
    ViewData["EventName"] = "CategorySelected";

    string TreeModalId = Guid.NewGuid().ToString();
    ViewData["TreeModalId"] = TreeModalId;

    var form_no = ViewData["form_no"];

}

<style>
    .table-header {
        background-color: #e9e9e9 !important;
    }
</style>

<form id="form1">
    <input type=hidden name="FORM_NO" id="FORM_NO" value="@form_no" />
    <input type=hidden name="USER_TYPE" id="USER_TYPE" value="" />
    <input type=hidden name="STATUS_DESC" id="STATUS_DESC" value="" />
    <input type=hidden name="FORM" id="FORM" value="" />
    <input type=hidden name="STATUSWORDING" id="STATUSWORDING" value="" />
    <input type=hidden name="FORM_TYPE" id="FORM_TYPE" value="" />
    <input type=hidden name="STATUS" id="STATUS" value="" />
    <input type=hidden name="ACTION_NAME" id="ACTION_NAME" value="" />

    <input type="hidden" id="TICKET_INFO" name="TICKET_INFO" value="" />

    <input type="hidden" id="CATEGORY_ID" name="CATEGORY_ID" value="" />
    <input type="hidden" id="CATEGORY_NAME" name="CATEGORY_NAME" value="" />
    <input type="hidden" id="CATEGORY_NAME_TMP" name="CATEGORY_NAME_TMP" value="" />
    <input type="hidden" id="storeType" />


    <input type="hidden" id="STORE_TYPE" value="" />
    <input type="hidden" id="IVRCODE" name="IVRCODE" value="" />

    <input type="hidden" id="SELFCONFIG" name="SELFCONFIG" value="N" />
    <input type="hidden" id="VENDER_ID" name="VENDER_ID" value="" />

    <input type="hidden" id="FORM_ACTION" name="FORM_ACTION" value="" />
    <input type="hidden" id="AMOUNT_CONFIG" name="AMOUNT_CONFIG" value="" />

    <div>
        <div class="table-responsive  bg-white" style="overflow-y: hidden;">
            <table class="table table-bordered align-middle" style="table-layout: fixed;">
                <tbody>
                    <tr>
                        <th colspan="6" class="table-header text-primary fs-6 ps-3 rmTable_Header" id="rmTable_Header1">
                            請填寫相關資料，以利後續報修處理 !
                        </th>
                    </tr>
                    <tr>
                        <th class="table-header ">公司別</th>
                        <td>KGT</td>
                        <th class="table-header ">店格</th>
                        <td>CONCEPT STORE</td>
                        <th class="table-header">IVR Code</th>
                        <td>2401</td>
                    </tr>
                    <tr>
                        <th class="table-header">通路</th>
                        <td>CONCEPT</td>
                        <th class="table-header">區域</th>
                        <td>N</td>
                        <th class="table-header">店名</th>
                        <td>遠傳集團-旗艦店</td>
                    </tr>
                    <tr>
                        <th class="table-header">eMails</th>
                        <td>KGFLAGSHIP</td>
                        <th class="table-header">店長/聯絡人</th>
                        <td>王美虹</td>
                        <th class="table-header">緊急電話</th>
                        <td>02-23888825 轉1680</td>
                    </tr>
                    <tr>
                        <th class="table-header">區經理 / 業務</th>
                        <td>朱欣文</td>
                        <th class="table-header">店長電話</th>
                        <td>0936-062-442</td>
                        <th rowspan="4" class="table-header">營業時間</th>
                        <td rowspan="4" style="text-wrap:wrap">
                            週一～五 1100～2030，
                            星期六 1100～2100
                        </td>
                    </tr>
                    <tr>
                        <th class="table-header">裝潢型態</th>
                        <td>Deployment</td>
                        <th class="table-header">傳真電話</th>
                        <td></td>
                    </tr>
                    <tr>
                        <th class="table-header">地址</th>
                        <td colspan="3">XXXXX</td>
                    </tr>
                    <tr>
                        <th class="table-header">備註</th>
                        <td colspan="3"></td>
                    </tr>

                    <tr>
                        <th class="table-header">開單者</th>
                        <td id="EMPNAME">
                        </td>
                        <th class="table-header">開單者連絡電話</th>
                        <td id="EMPTEL">
                        </td>
                        <th class="table-header">報修型態</th>
                        <td>
                            <select class="form-control initSelect2" id="TT_CATEGORY">
                                <option value="一般">一般</option>
                                @* <option>緊急 (新開單)</option> *@
                                @* <option>緊急 (補單)</option> *@
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">報修品項</th>
                        <td colspan="2">
                            <button class="btn  btn-info" id="rmBtn_SelectItems">選擇項目</button>
                        </td>
                        <th colspan="3"></th>
                    </tr>

                    <tr>
                        <th class="table-header">一個月內覆修</th>
                        <td>
                            <div class="d-flex gap-4 justify-content-center align-items-center">
                                <label role="button">
                                    <input type="radio" name="Repair" value="Y" /> 是
                                </label>
                                <label role="button">
                                    <input type="radio" name="Repair" value="N" /> 否
                                </label>
                            </div>
                        </td>

                        <th class="table-header">補單</th>
                        <td>
                            <div class="d-flex gap-4 justify-content-center align-items-center">
                                <label>
                                    <input type="radio" name="Resupply" value="Y" /> 是
                                </label>
                                <label>
                                    <input type="radio" name="Resupply" value="N" /> 否
                                </label>
                            </div>
                        </td>

                        <th class="table-header">門市自行尋商</th>
                        <td id="SELFCONFIG_NOTE">
                            N
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">報修日期</th>
                        <td id="CREATE_TIME">
                        </td>
                        <th class="table-header" rowspan="3">報修品項圖樣</th>
                        <td rowspan="3">
                        </td>
                        <th class="table-header">報修廠商</th>
                        <td>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">驗收日</th>
                        <td>
                            <input class="form-control" type="date" />
                        </td>
                        <th class="table-header">報修廠商聯絡人</th>
                        <td>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">保固期日期</th>
                        <td>
                            <input class="form-control" type="date" />
                        </td>
                        <th class="table-header">報修廠商聯絡電話</th>
                        <td>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="6" class="table-header text-primary fs-6 ps-3 rmTable_Header" id="TT_CATEGORY_LABEL">
                            報修品項檢查事項及狀況描述
                        </th>
                    </tr>

                    <tr>
                        <th class="table-header" id="TT_CATEGORY_NOTE_LABEL">報修品項檢查事項</th>
                        <td colspan="5">
                            <span id="TT_CATEGORY_NOTE_PANNEL"></span>&nbsp;
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header" id="TT_CATEGORY_DESC_LABEL">報修品項狀況描述</th>
                        <td colspan="5">
                            <label>
                                <span id="TT_CATEGORY_DESC_PANNEL"></span>&nbsp;
                            </label>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">
                            <span id="REMARK_LABEL1">報修描述與備註</span>
                            <br />
                            <span id="REMARK_LABEL2" style="color: Red;">例如:不冷、漏水、無法啟動等等…</span>
                        </th>
                        <td colspan="5" class="p-1">
                            <textarea class="form-control" rows="3" id="REMARK" name="REMARK"></textarea>
                        </td>
                    </tr>

                    <tr bgcolor="#FF80C0">
                        <th colspan="6" class="table-header text-primary fs-6 ps-3 rmTable_Header" id="rmTable_Header2">請填寫相關處理資訊,利於後續報修處理,謝謝!</th>
                    </tr>
                    <tr>
                        <td bgcolor="#FFDDEE">前一筆備註說明：</td>
                        <td colspan="5"><label id="PreHandleDesc"></label></td>
                    </tr>
                    <tr>
                        <td class="table-header" id="DESCRIPTION_DESC">備註說明：</td>
                        <td colspan="5" class="p-1">
                            <textarea class="form-control" id="DESCRIPTION" name="DESCRIPTION" rows="3" cols="90"></textarea>
                        </td>
                    </tr>

                    <tr id="SELECTSTATUS_PANEL">
                        <td bgcolor="#FFDDEE" id="SELECTSTATUS_DESC">表單狀態：</td>
                        <td colspan="5">
                            <select id="SELECTSTATUS" name="SELECTSTATUS" class="form-control initSelect2">
                                <option value="">請選擇...</option>
                                <option value="COMPLETE">完修</option>
                                <option value="PENDING">待料</option>
                                <option value="OFFER">報價</option>
                                <option value="ASSETER">拒絕</option>
                                <option value="NOSHOW">不需到場處理</option>
                            </select>
                        </td>
                    </tr>
                    <tr id="COMPLETE_PANEL">
                        <td bgcolor="#FFDDEE" id="COMPLETETIME_DESC">完修日期：</td>
                        <td colspan="5">
                            <input type="text" id="COMPLETETIME" name="COMPLETETIME" style="text-align:center;" />
                            <img id="COMPLETE_DATE" name="COMPLETE_DATE" src="/images/icon/select.gif" style="cursor:pointer;" onClick="DoCal(document.all.COMPLETETIME, '?dateFormat=%Y/%m/%d&amp;showTime=false;');if (Date.parseString(document.all.COMPLETETIME.value,'yyyy/MM/dd').isAfter(new Date()) == true) { alert('完修日期不能大於今天！');document.all.COMPLETETIME.value=''; }" />
                        </td>
                    </tr>
                    <tr id="PENDING_PANEL">
                        <td bgcolor="#FFDDEE" id="PRECOMPLETETIME_DESC">預計完成日期：</td>
                        <td colspan="5">
                            <input type="text" id="PRECOMPLETETIME" name="PRECOMPLETETIME" style="text-align:center;" />
                            <img id="PRECOMPLETE_DATE" name="PRECOMPLETE_DATE" src="/images/icon/select.gif" style="cursor:pointer;" onClick="DoCal(document.all.PRECOMPLETETIME, '?dateFormat=%Y/%m/%d&amp;showTime=false');" />
                        </td>
                    </tr>

                    <tr id="OFFER_PANEL" style="display:none;">
                    </tr>

                    <tr id="ASSETER_PANEL" style="display:none;">
                    </tr>

                    <tr id="AMOUNT_PANEL" style="display:none;">
                        <td bgcolor="#FFDDEE" style="display:none;">金額彙整欄：</td>
                        <td colspan="5" style="display:none;">
                            <input type="hidden" id="FORM_ACTION" value="INSERT" />
                            <input type="hidden" id="AMOUNT_CONFIG" />

                            <input type="hidden" id="AJAXScriptManager" />

                            <table id="tbl1" runat="server">
                                <tr>
                                    <td>
                                        <table border="1">
                                            <tr>
                                                <th>費用種類</th>
                                                <th>維修細項</th>
                                                <th>檢測故障原因</th>
                                                <th>維修處理動作</th>
                                                <th>數量</th>
                                                <th>單位</th>
                                                <th>單價</th>
                                                <th>備註</th>
                                            </tr>
                                            <tr>
                                                <td>
                                                    <select class="form-control initSelect2" id="EXPENSE_TYPE" name="EXPENSE_TYPE">
                                                    </select>
                                                </td>
                                                <td>
                                                    <input id="EXPENSE_DESC_TEXT" class="form-control" />

                                                    <select class="form-control initSelect2" id="EXPENSE_DESC_SEL" name="EXPENSE_DESC_SEL">
                                                    </select>

                                                    <select class="form-control initSelect2" id="EXPENSE_DESC_SEL" style="width: 150px" class="select_class">
                                                    </select>
                                                </td>
                                                <td>
                                                    <asp:TextBox ID="FAULT_REASON" runat="server"></asp:TextBox>
                                                </td>
                                                <td>
                                                    <asp:TextBox ID="REPAIR_ACTION" runat="server"></asp:TextBox>
                                                </td>
                                                <td>
                                                    <asp:TextBox ID="QTY" runat="server" Width="80px" style="text-align:center;" onChange="if (isNumeric(this.value) == false) { alert('請輸入數字！');this.value=''; };"></asp:TextBox>
                                                </td>
                                                <td>
                                                    <asp:TextBox ID="UNIT" runat="server" Width="80px" style="text-align:center;"></asp:TextBox>
                                                </td>
                                                <td>
                                                    <asp:TextBox ID="PRICE" runat="server" Width="80px" style="text-align:center;" onChange="if (isNumeric(this.value) == false) { alert('請輸入數字！');this.value=''; };"></asp:TextBox>
                                                </td>
                                                <td>
                                                    <span class="leftInfo"><img src="/Images/Icon/view.gif" align="absMiddle" /><span class="leftTooltip"><asp:Label ID="COMMENT" runat="server"></asp:Label></span></span>
                                                </td>
                                                <td>
                                                    <input type="button" id="InsertButton" value="新增一筆" onclick="addItemRow();" onMouseOver="this.className = 'customButtonHover';" onMouseOut="this.className = 'customButton';" Class="customButton" style="vertical-align:middle;border:none 0px black;" />
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="6" width="100%" align="center">

                            <button id="SubmitForm" onclick="event.returnValue = CheckFormInTicket();" style="">送  出</button>

                            <span id=submitbutton>
                                @* @(Html.Raw(SubmitButton)) *@
                            </span>
                            <button type="button" onclick="parent.window.close();">關閉視窗</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</form>
<partial name="Form/_RMItemListSelfVendor" view-data='new ViewDataDictionary(ViewData)' />
<partial name="Form/_RMItemTree" view-data='new ViewDataDictionary(ViewData)' />

<script>

    //initModel.Type : 1.新開單  , 2.自行尋商
    function initFormTable(initModel) {
        if (initModel.Type === 1) {
            $("#rmBtn_SelectItems").on("click", function () {
                $("#@(TreeModalId)").modal("show");
            });
            $("#SelfFindBussiness").text("N");
        }
        else if (initModel.Type === 2) {
            $("#rmBtn_SelectItems").on("click", function () {
                $("#RMItemListSelfVendorModal").modal("show");
            });
            $("#SelfFindBussiness").text("Y");
        }
        else if (initModel.Type === 3) {
            $("#rmBtn_SelectItems").remove();
            $("#rmBtn_Add").remove();
            $("#rmBtn_Create").remove();
            $(".rmClass_DeleteDetail").remove();
            $("#rmTable_Header1").html("");
            $("#rmTable_Header1").append("門市資訊")

            let statusSpan = $("<span class='text-success' style='float:right;background-color: cornsilk;'></span").html("*目前表單狀態: 審單中")
            $("#rmTable_Header1").append(statusSpan);
        }
    }

    $(document).on("CategorySelected", function (event, data) {
        $("#rmBtn_SelectItems").text(data.selectedItemText);
    });

    $(function () {
        //initSelect2
        $(".initSelect2").select2({
            placeholder: "請選擇",
            allowClear: true
        });
    });

    function GetDetail() {
        hideLoader();
        var formNo = '@form_no';
        var data = { formNo: formNo };
        $.ajax({
            type: 'POST',
            url: "@(config.GetBackendUrl() + Url.Action("GetDetail"))",
            data: data,
            dataType: 'json',
            success: function (data) {
                if (data.Success == true) {
                    $('#USER_TYPE').val(data.FORM_ACCESS_CONTROL.USER_TYPE);
                    $('#STATUS_DESC').val(data.APPROVE_FORM.STATUS_NAME);
                    $('#FORM').val(data.APPROVE_FORM.FORM_TYPE);
                    $('#FORM_TYPE').val(data.APPROVE_FORM.FORM_TYPE);
                    $('#STATUS').val(data.APPROVE_FORM.STATUS);
                    $('#ACTION_NAME').val(data.ACTION_NAME);
                    $('#STORE_TYPE').val(data.STORE_PROFILE.STORE_TYPE);
                    $('#IVRCODE').val(data.STORE_PROFILE.IVR_CODE);

                    var RequireField = data.RequireField;
                    var accesscontrol = RequireField.split(/,/);

                    for (i = 0; i < accesscontrol.length; i++) {
                        $('#' + accesscontrol[i]).attr('required', '');
                    }

                    var UpdateField = data.UpdateField;
                    // 表單權限處理
                    form_access_control(document.form1, UpdateField);

                    // 最後一次備註說明
                    $('#PreHandleDesc').val(data.PreHandleDesc)

                    if (data.FranchiseMsg != "") {
                        alert(data.FranchiseMsg);
                    }

                    if (data.tt_category == "緊急(新開單)") {

                        var option = new Option('緊急(新開單)', '緊急(新開單)', true, true);
                        $('#TT_CATEGORY').append(option).trigger('change');
                    }

                    $("#TT_CATEGORY").val(data.tt_category);
                    $("#TT_CATEGORY").trigger('change');

                    if (data.ftt_formDTO.repair == 'Y') {
                        $('[name="Repair"][value="Y"]').prop('checked', true);
                    } else {
                        $('[name="Repair"][value="N"]').prop('checked', true);
                    }

                    if (data.ftt_formDTO.Resupply == 'Y') {
                        $('[name="Resupply"][value="Y"]').prop('checked', true);
                    } else {
                        $('[name="Resupply"][value="N"]').prop('checked', true);
                    }

                    $('#CREATE_TIME').val(data.CREATE_TIME);

                    $('#EMPNAME').val(data.ftt_formDTO.empname);
                    $('#EMPTEL').val(data.ftt_formDTO.emptel);
                    $('#CATEGORY_ID').val(data.ftt_formDTO.category_id);
                    $('#CATEGORY_NAME').val(data.ftt_formDTO.category_name);
                    $('#VENDER_ID').val(data.ftt_formDTO.vender_id);
                    $('#SELFCONFIG').val(data.ftt_formDTO.selfconfig);
                    $('#SELFCONFIG_NOTE').text(data.ftt_formDTO.selfconfig);
                    $('#TT_CATEGORY_NOTE_PANNEL').text(data.ftt_formDTO.checkitem);
                    $('#TT_CATEGORY_DESC_PANNEL').text(data.ftt_formDTO.descr);
                    $('#REMARK').val(data.ftt_formDTO.remark);

                    if (data.ftt_formDTO.category_id == '1275') {
                        document.all.TT_CATEGORY_LABEL.innerHTML = "報修前確認事項及損壞狀況描述：";
                        document.all.TT_CATEGORY_NOTE_LABEL.innerHTML = "報修前檢查事項：";
                        document.all.TT_CATEGORY_DESC_LABEL.innerHTML = "報修機台編號：";
                        document.all.REMARK_LABEL1.innerHTML = "報修問題描述：";
                        $('#REMARK_LABEL2').show();
                    }
                    else {
                        document.all.TT_CATEGORY_LABEL.innerHTML = "報修品項檢查事項及狀況描述：";
                        document.all.TT_CATEGORY_NOTE_LABEL.innerHTML = "報修品項檢查事項：";
                        document.all.TT_CATEGORY_DESC_LABEL.innerHTML = "報修品項狀況描述：";
                        document.all.REMARK_LABEL1.innerHTML = "報修描述與備註：";
                        $('#REMARK_LABEL2').hide();
                    }

                    if (data.ftt_formDTO.selfconfig == "N") {
                        $('#VENDER_ID').val(data.ftt_formDTO.order_id);
                        $('#VENDER_NAME').text(data.ftt_formDTO.merchant_name);
                        $('#CP_NAME').text(data.ftt_formDTO.cp_name);
                        $('#CP_TEL').text(data.ftt_formDTO.cp_tel);
                    }
                    else {
                        $('#VENDER_NAME').text(data.storename);
                    }

                    showLoader();
                } else {
                    alert(data.Data);
                }
            },
            error: function (msg) {

            }
        });
    }

    function form_access_control(formobj, allowed_field) {
        var vobj = eval(formobj).all;

        if (vobj != null) {
            for (var i = 0; i < vobj.length; i++) {
                if (vobj.item(i).name != null) {
                    if (vobj.item(i).name.length > 1) {
                        if (vobj.item(i).type != 'hidden') {
                            if (check_field_access(vobj.item(i).name, allowed_field) != true) {
                                //alert('Disable '+vobj.item(i).name);
                                disable_field(vobj.item(i));
                            } else {
                                //alert('Enable '+vobj.item(i).name);
                                enable_field(vobj.item(i));
                            }   // Check ACL
                        }      // != hidden
                    }         // Name length > 2
                }           // Name != null
            }              // for
        }                // obj != null
    }
</script>