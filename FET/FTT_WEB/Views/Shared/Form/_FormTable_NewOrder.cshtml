@model NewOrderVM
@{
    string TreeModalId = Guid.NewGuid().ToString("N");
    ViewData["TreeModalId"] = TreeModalId;
    string ModalId2 = Guid.NewGuid().ToString("N");
    ViewData["ModalId2"] = ModalId2;
    string DialogVenderModalId = Guid.NewGuid().ToString("N");
    ViewData["DialogVenderModalId"] = DialogVenderModalId;

    StoreVM StoreVM = Model.StoreVM;
}

<style>
    .table-header {
        background-color: #e9e9e9 !important;
    }

    .TrOddChild {
        background-color: white;
    }

    .TrEvenChild {
        background-color: gray;
    }
</style>
<div>
    <div class="table-responsive  bg-white" style="overflow-y: hidden;">
        <form id="form">
            <table class="table table-bordered align-middle" style="table-layout: fixed;">
                <tbody>
                    <tr>
                        <th colspan="6" class="table-header text-primary fs-6 ps-3 rmTable_Header" id="rmTable_Header1">
                            請填寫相關資料，以利後續報修處理 !
                        </th>
                    </tr>
                    <tr>
                        <th class="table-header ">公司別：</th>
                        <td>@(StoreVM.Company?.ToHtmlString())</td>
                        <th class="table-header ">店格：</th>
                        <td>
                            @(StoreVM.StoreType?.ToHtmlString())
                            <input type="hidden" id="STORE_TYPE" value="@(StoreVM.StoreType)" />
                        </td>
                        <th class="table-header">IVR Code：</th>
                        <td>
                            @(StoreVM.IVRCode?.ToHtmlString())
                            <input type="hidden" asp-for="IVRCODE" />
                        </td>
                    </tr>
                    <tr>
                        <th class="table-header">通路：</th>
                        <td>@(StoreVM.Channel?.ToHtmlString())</td>
                        <th class="table-header">區域：</th>
                        <td>@(StoreVM.Area?.ToHtmlString())</td>
                        <th class="table-header">店名：</th>
                        <td>@(StoreVM.StoreName?.ToHtmlString())</td>
                    </tr>
                    <tr>
                        <th class="table-header">eMails：</th>
                        <td>@(StoreVM.EMail?.ToHtmlString())</td>
                        <th class="table-header">店長/聯絡人：</th>
                        <td>@(StoreVM.Owner?.ToHtmlString())</td>
                        <th class="table-header">緊急電話：</th>
                        <td>@(StoreVM.PhoneUrgent?.ToHtmlString())</td>
                    </tr>
                    <tr>
                        <th class="table-header">區經理 / 業務：</th>
                        <td>@(StoreVM.Manager?.ToHtmlString())</td>
                        <th class="table-header">店長電話：</th>
                        <td>@(StoreVM.Phone?.ToHtmlString())</td>
                        <th rowspan="4" class="table-header">營業時間：</th>
                        <td rowspan="4" valign="middle">
                            <table width="100%" height="80" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="">週一~五</td>
                                    <td style="">:</td>
                                    <td>@(StoreVM.BusinessTime1?.ToHtmlString())</td>
                                </tr>
                                <tr>
                                    <td style="">星期六</td>
                                    <td style=""> :</td>
                                    <td>@(StoreVM.BusinessTime2?.ToHtmlString())</td>
                                </tr>
                                <tr>
                                    <td style="">星期日</td>
                                    <td style="">:</td>
                                    <td>@(StoreVM.BusinessTime3?.ToHtmlString())</td>
                                </tr>
                                <tr>
                                    <td style="">國定假日</td>
                                    <td style="">:</td>
                                    <td>@(StoreVM.BusinessTime4?.ToHtmlString())</td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <th class="table-header">裝潢型態：</th>
                        <td>@(StoreVM.DecorationCondition?.ToHtmlString())</td>
                        <th class="table-header">傳真電話：</th>
                        <td>@(StoreVM.PhoneFax?.ToHtmlString())</td>
                    </tr>
                    <tr>
                        <th class="table-header">地址：</th>
                        <td colspan="3">@(StoreVM.Address?.ToHtmlString())</td>
                    </tr>
                    <tr>
                        <th class="table-header">備註：</th>
                        <td colspan="3">@(StoreVM.Note?.ToHtmlString())</td>
                    </tr>

                    <tr>
                        <th class="table-header">開單者：</th>
                        <td>
                            <input asp-for="EMPNAME" size="20" class="form-control" />
                        </td>
                        <th class="table-header">開單者連絡電話</th>
                        <td>
                            <input asp-for="EMPTEL" class="form-control" />
                        </td>
                        <th class="table-header">報修型態：</th>
                        <td>
                            <select asp-for="TT_CATEGORY" class="form-control">
                            </select>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">報修品項：</th>
                        <th colspan="3">
                            <button type="button" class="btn btn-info" id="rmBtn_SelectItems">選擇項目</button>
                            <span id="Category_Desc"></span>
                            <span id="Category_Desc_Note"></span>
                            <input type="hidden" asp-for="TemplateItem.CATEGORY_ID" />
                            <input type="hidden" asp-for="TemplateItem.CATEGORY_NAME" />
                            <input type="hidden" asp-for="CATEGORY_NAME_TMP" />
                            <input type="hidden" id="storeType" />
                            <marquee id="@Html.IdFor(m => m.Prompt)" scrollamount="2" bgcolor="yellow" style="color:blue;">@(Model.Prompt?.ToHtmlString())</marquee>
                        </th>
                    </tr>

                    <tr>
                        <th class="table-header">一個月內覆修：</th>
                        <td>
                            <div class="d-flex gap-4 justify-content-center align-items-center">
                                <label role="button">
                                    <input type="radio" name="@(nameof(Model.REPAIR))" value="Y" /> 是
                                </label>
                                <label role="button">
                                    <input type="radio" name="@(nameof(Model.REPAIR))" value="N" /> 否
                                </label>
                            </div>
                        </td>

                        <th class="table-header">補單：</th>
                        <td>
                            <div class="d-flex gap-4 justify-content-center align-items-center">
                                <label>
                                    <input type="radio" name="@(nameof(Model.RESUPPLY))" value="Y" /> 是
                                </label>
                                <label>
                                    <input type="radio" name="@(nameof(Model.RESUPPLY))" value="N" /> 否
                                </label>
                            </div>
                        </td>

                        <th class="table-header">門市自尋尋商：</th>
                        <td id="SelfFindBussiness">
                            <span id="SELFCONFIG_NOTE">N</span>
                            <input type="hidden" asp-for="SELFCONFIG" value="N" />
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">報修日期：</th>
                        <td>
                            <span>@(Model.CREATE_TIME?.ToHtmlString())</span>
                        </td>
                        <th class="table-header" rowspan="3">報修品項圖樣：</th>
                        <td rowspan="3">
                            <span id="TT_IMAGE_PANNEL"></span>
                            <div class="d-flex justify-content-center">
                                <img class="m-0" id="TT_IMAGE" src="@(Url.Content("~/images/Item/no-product.gif"))" data-default-src="@(Url.Content("~/images/Item/no-product.gif"))" width="100" onclick="window.open(this.src,'showImg', 'status=no,toolbar=no,scrollbars=yes,resizable=yes,width=600,Height=500');" style="cursor:pointer;" align="middle" />
                            </div>
                        </td>
                        <th class="table-header">
                            報修廠商：
                            <button id="btnSelectVender" type="button" class="btn btn-info">選擇項目</button>
                        </th>
                        <td>
                            <span id="VENDER_NAME_DISPLAY"></span>
                            <input type="hidden" asp-for="TemplateItem.VENDER_NAME" />
                            <input type="hidden" asp-for="TemplateItem.VENDER_ID" />
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">驗收日：</th>
                        <td>
                            <span>@(Model.APPROVALDATE?.ToHtmlString())</span>
                        </td>
                        <th class="table-header">報修廠商聯絡人：</th>
                        <td>
                            <span id="CP_NAME"></span>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">保固期日期：</th>
                        <td>
                            <span>@(Model.WARRANTYTIME?.ToHtmlString())</span>
                        </td>
                        <th class="table-header">報修廠商聯絡電話</th>
                        <td>
                            <span id="CP_TEL"></span>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="6" class="table-header text-primary fs-6 ps-3 rmTable_Header" id="TT_CATEGORY_LABEL">
                            報修品項事項及狀況描述：
                        </th>
                    </tr>

                    <tr>
                        <th class="table-header" id="TT_CATEGORY_NOTE_LABEL">報修品項檢查事項：</th>
                        <td colspan="5">
                            <span id="TT_CATEGORY_NOTE_PANNEL" class="form-check m-checkbox-inline" data-value=""></span>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header" id="TT_CATEGORY_DESC_LABEL">報修品項狀況描述：</th>
                        <td colspan="5">
                            <span id="TT_CATEGORY_DESC_PANNEL" class="form-check m-checkbox-inline" data-value=""></span>
                        </td>
                    </tr>

                    <tr>
                        <th class="table-header">
                            <p id="REMARK_LABEL1" class="m-0">報修描述與備註</p>
                            <br />
                            <span id="REMARK_LABEL2" class="style7 d-none" style="color:Red">例如:不冷、漏水、無法啟動等等…</span>
                        </th>
                        <td colspan="5" class="p-1">
                            <textarea asp-for="TemplateItem.REMARK" class="form-control" rows="3" cols="90"></textarea>
                        </td>
                    </tr>

                    <tr>
                        <th colspan="6" class="text-end">
                            <button type="button" class="btn btn-info" id="rmBtn_Add">新增資料</button>
                        </th>
                    </tr>

                    <tr>
                        <td colspan="6">
                            <div class="table-responsive  bg-white pt-1">
                                <table class="table table-bordered align-middle" style="table-layout: fixed;">
                                    <tbody id="TTItemList">
                                        <tr>
                                            <th style="width:50px">刪</th>
                                            <th>維修品項</th>
                                            <th>維修廠商</th>
                                            <th>狀況描述</th>
                                            <th>報修備註</th>
                                        </tr>
                                        <tr id="noData" style="background-color:white;">
                                            <td class="text-center" colspan="5"><B><u>尚未新增報修資料</u></B></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="6" class="text-center">
                            <button type="button" class="btn btn-primary" id="rmBtn_Create">開立報修單</button>
                        </td>
                    </tr>

                </tbody>
            </table>
        </form>
    </div>
</div>

<partial name="Form/_RMItemListSelfVendor" view-data='new ViewDataDictionary(ViewData)' />
<partial name="Form/_RMItemTree" view-data='new ViewDataDictionary(ViewData)' />
<partial name="Form/_DialogVender" view-data='new ViewDataDictionary(ViewData)' />

<script>
    var context = context || {};
    $(function () {
        context.TTItemList = {
            count: 0
        };
        //initSelect2
        $(".initSelect2").select2({
            placeholder: "請選擇",
            allowClear: true
        });
    });

    //initModel.Type : 1.新開單  , 2.自行尋商
    function initFormTable (initModel) {
        if (initModel.Type === 1) {
            $("#rmBtn_SelectItems").on("click", function () {
                $("#@(TreeModalId)").modal("show");
            });
            $("#SELFCONFIG_NOTE").text("N");
            $('#@(Html.IdFor(m => m.TT_CATEGORY))').select2({
                data: [
                    { id: '一般', text: '一般' },
                ]
            });
            $('#@(TreeModalId)').on('hidden.bs.modal', function (e) {
                let ctx = context['@(TreeModalId)'];

                if (ctx.result && ctx.selectedItem) {
                    let data = ctx.selectedItem.original['OtherAttr'];
                    afterSelectCategory(data);
                }
            });
        }
        else if (initModel.Type === 2)
        {// 自行尋商
            $("#rmBtn_SelectItems").on("click", function () {
                $("#@(ModalId2)").modal("show");
            });
            $("#SELFCONFIG_NOTE").text("Y");
            $('#@(Html.IdFor(m => m.SELFCONFIG))').val('Y');
            $('#btnSelectVender').addClass('d-none');
            $('#@Html.IdFor(m => m.Prompt)').addClass('d-none');
            // 報修廠商固定為登入者
            $('#@(Html.IdFor(m => m.TemplateItem.VENDER_ID))').val('@(Model.IVRCODE)');
            $('#@(Html.IdFor(m => m.TemplateItem.VENDER_NAME))').val('@(Model.EMPNAME)');
            $('#VENDER_NAME_DISPLAY').text('@(Model.EMPNAME?.ToHtmlString())');
            $('#@(Html.IdFor(m => m.TT_CATEGORY))').select2({
                data: [
                    { id: '一般', text: '一般' },
                    { id: '緊急(補單)', text: '緊急(補單)' },
                ]
            });
            $('#@(ModalId2)').on('hidden.bs.modal', function (e) {
                let ctx = context['@(ModalId2)'];

                if (ctx.result && ctx.selectedItem) {
                    afterSelectCategory(ctx.selectedItem);
                }
            });
        }
    }

    function afterSelectCategory(data) {
        context.categoryData = data;
        let categoryId = data['CATEGORY_ID'] || '';
        let valSELFCONFIG = $('#@(Html.IdFor(m => m.SELFCONFIG))').val();
        // [TTInfo.ascx]getCISID()
        $('#@(Html.IdFor(m => m.TemplateItem.CATEGORY_ID))').val(categoryId);
        $('#CATEGORY_NAME_TMP').val(data['CATEGORY_NAME_TMP'] || '');
        $('#@(Html.IdFor(m => m.TemplateItem.CATEGORY_NAME))').val(data['CATEGORY_NAME'] || '');
        $('#Category_Desc').text(data['CATEGORY_NAME'] || '');
        // 修改類別項目時，廠商也要重新選擇
        if (valSELFCONFIG == 'N') {
            $('#@(Html.IdFor(m => m.TemplateItem.VENDER_ID))').val('');
            $('#VENDER_NAME').text('');
            $('#CP_NAME').text('');
            $('#CP_TEL').text('');
        }

        // [TTInfo.ascx]RetireveItemImage()
        if (data['TT_IMAGE']) {
            $('#TT_IMAGE').attr('src', data['TT_IMAGE']);
        }
        else {
            $('#TT_IMAGE').attr('src', $('#TT_IMAGE').data('defaultSrc'));
        }

        $('#TT_CATEGORY_NOTE_PANNEL').html('');
        $('#TT_CATEGORY_DESC_PANNEL').html('');

        if (categoryId) {
            // isNewTT 必定為 true
            // [TTInfo.ascx]RetrieveTTCount()
            showLoader();
            $.ajax({
                url: '@(Url.Action("RetrieveTTCount","NewOrder")?.ToHtmlString())',
                dataType: 'json',
                type: 'POST',
                data: {
                    cisid: categoryId,
                    ivrCode: $('#IVRCODE').val(),
                }
            })
                .done((response) => {
                    var msg = response.Success ? response.Data : response.Message;
                    var alertType = response.Success ? "success" : "error";

                    if (response.Success) {
                        if (response['Data'] == 'YES') {
                            swal({
                                text: '此項目今天已報修，請再確認是否真的要送出！',
                                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                                icon: 'warning'
                            });
                        }
                    }
                    else {
                        swal({
                            text: response.Message,
                            button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                            icon: 'error',
                        });
                    }
                })
                .fail((err) => {
                    console.log(err);
                })
                .always(() => {
                    hideLoader();
                    if (valSELFCONFIG == 'N') {
                        $('#btnSelectVender').click();
                    }
                    // [TTInfo.ascx]RetrieveCategoryNote()
                    let note = data['TT_CATEGORY_NOTE'];
                    if (note) {
                        let list = note.split(';');
                        let $container = $('#TT_CATEGORY_NOTE_PANNEL');
                        let $cblist = [];
                        $.each(list, function (index, value) {
                            let $cb = buildCheckbox({
                                id: value,
                                text: value,
                                name: '@(Html.NameFor(m => m.TemplateItem.ITEMNOTE))[]',
                                inputClassNames: 'cb-item',
                            });
                            $cblist.push($cb);
                        });
                        $container.append($cblist);
                    }
                    // [TTInfo.ascx]RetrieveCategoryDesc()
                    let desc = data['TT_CATEGORY_DESC'];
                    if (desc) {
                        let list = desc.split(';');
                        let $container = $('#TT_CATEGORY_DESC_PANNEL');
                        let $cblist = [];
                        $.each(list, function (index, value) {
                            let $cb = buildCheckbox({
                                id: value,
                                text: value,
                                name: '@(Html.NameFor(m => m.TemplateItem.ITEMDESC))[]',
                                inputClassNames: 'cb-item',
                            });
                            $cblist.push($cb);
                        });
                        $container.append($cblist);
                    }
                });

            // [TTInfo.ascx]setCATEGORY_LABEL
            if (categoryId == '1275') {
                $('#TT_CATEGORY_LABEL').text('報修前確認事項及損壞狀況描述：');
                $('#TT_CATEGORY_NOTE_LABEL').text('報修前檢查事項：');
                $('#TT_CATEGORY_DESC_LABEL').text('報修機台編號：');
                $('#REMARK_LABEL1').text('報修問題描述：');
                $('#REMARK_LABEL2').removeClass('d-none');
            } else {
                $('#TT_CATEGORY_LABEL').text('報修品項檢查事項及狀況描述：');
                $('#TT_CATEGORY_NOTE_LABEL').text('報修品項檢查事項：');
                $('#TT_CATEGORY_DESC_LABEL').text('報修品項狀況描述：');
                $('#REMARK_LABEL1').text('報修描述與備註：');
                $('#REMARK_LABEL2').addClass('d-none');
            }
        }
    }

    $('#btnSelectVender').on('click', function (e) {
        let formData = $('#form').serializeObject();
        let valSELFCONFIG = formData['@(nameof(Model.SELFCONFIG))'];
        let valTemplateItem = formData['@(nameof(Model.TemplateItem))'];
        let valCATEGORY_ID = valTemplateItem['@(nameof(NewOrderTTItemVM.CATEGORY_ID))'];

        if (valSELFCONFIG == 'Y') {
            return;
        }

        // [TTInfo.ascx]chooseVendor()
        if (!valCATEGORY_ID) {
            swal({
                text: '請先選取報修品項，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning',
            });
            return;
        }

        let ctx = context['@(DialogVenderModalId)'];
        ctx['IVRCODE'] = formData['@(nameof(Model.IVRCODE))'];
        ctx['CATEGORY_ID'] = valCATEGORY_ID;
        ctx['IFWARRANT'] = 'Y';

        $('#@(DialogVenderModalId)').modal('show');
    });

    $('#rmBtn_Add').on('click', async function (e) {
        // [TTInfo.ascx]insertItem()
        let formData = $('#form').serializeObject();
        let valREPAIR = formData['@(nameof(Model.REPAIR))'];
        let valRESUPPLY = formData['@(nameof(Model.RESUPPLY))']
        let valTemplateItem = formData['@(nameof(Model.TemplateItem))'];
        let valCATEGORY_ID = valTemplateItem['@(nameof(NewOrderTTItemVM.CATEGORY_ID))'];
        let valCATEGORY_NAME = valTemplateItem['@(nameof(NewOrderTTItemVM.CATEGORY_NAME))'];
        let valITEMNOTE = valTemplateItem['@(nameof(NewOrderTTItemVM.ITEMNOTE))'] || [];
        let valITEMDESC = valTemplateItem['@(nameof(NewOrderTTItemVM.ITEMDESC))'] || [];
        let valVENDER_ID = valTemplateItem['@(nameof(NewOrderTTItemVM.VENDER_ID))'];
        let valVENDER_NAME = valTemplateItem['@(nameof(NewOrderTTItemVM.VENDER_NAME))'];
        let valREMARK = valTemplateItem['@(nameof(NewOrderTTItemVM.REMARK))'];

        if (!valCATEGORY_ID) {
            swal({
                text: '請先選擇報修品項，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning'
            });
            return;
        }

        // [TTInfo.ascx]checkItem()
        let note = context.categoryData['TT_CATEGORY_NOTE'];
        if (note) {
            let list = note.split(';');

            for (let i = 0; i < list.length; i++) {
                if (!valITEMNOTE.includes(list[i])) {
                    swal({
                        text: `請先檢查項目："${list[i]}"\n\n再重新點選﹝新增資料﹞，謝謝！`,
                        button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                        icon: 'warning'
                    });
                    return;
                }
            }
        }

        if (valCATEGORY_ID == '1275') {
            // 檢查 空調-賣場空調 的報修機台編號 是否有勾選
            let desc = context.categoryData['TT_CATEGORY_DESC'];
            if (desc) {
                let list = desc.split(';');

                if (valITEMDESC.length == 0) {
                    if (!valITEMDESC.includes(list[i])) {
                        swal({
                            text: '請選擇報修機台編號\n\n再重新點選﹝新增資料﹞，謝謝！',
                            button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                            icon: 'warning'
                        });
                        return;
                    }
                }
            }
        }
        if (!valREPAIR) {
            swal({
                text: '請先選擇是否[一個月覆修]，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning'
            });
            return;
        }

        if (!valRESUPPLY) {
            swal({
                text: '請先選擇是否[補單]，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning'
            });
            return;
        }

        // [TTInfo.ascx]formcheckdata()
        try {
            let ret = await $.ajax({
                url: '@(Url.Action("CheckRepairReported", "NewOrder")?.ToHtmlString())',
                dataType: 'json',
                type: 'POST',
                data: {
                    categoryId: valCATEGORY_ID,
                }
            });

            if (ret.Success) {
                if (ret.Data == 'Y') {
                    swal({
                        text: '此報修項目已報修，尚有未結案工單！',
                        button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                        icon: 'warning',
                    });
                    return;
                }
            }
            else {
                swal({
                    text: ret.Message,
                    button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                    icon: 'error',
                });
                return;
            }
        } catch (ex) {
            console.log(ex);
            return;
        }


        if (!valVENDER_ID) {
            swal({
                text: '請先選擇報修廠商，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning'
            });
            return;
        }

        if (!valREMARK) {
            swal({
                text: '請先填寫報修描述與備註，謝謝！',
                button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                icon: 'warning'
            });
            return;
        }

        let idx = context.TTItemList.count;
        let $container = $('#TTItemList');
        let $tr = $('<tr>')
            .attr({
                class: 'grid-item ' + (idx % 2 == 0 ? 'TrOddChild' : 'TrEvenChild'),
            });
        let $td0 = $('<td>');
        let $btnDelete = $('<button>')
            .attr({
                'class': 'btn btn-link text-danger icofont icofont-trash fs-6 p-1',
                'type': 'button',
            })
            .on('click', (e) => {
                var $control = $(e.currentTarget);
                const callDelete = () => {
                    let $trNow = $control.closest('tr');
                    $trNow.remove();
                    let $trList = $container.children('tr.grid-item');
                    context.TTItemList.count = $trList.length;

                    if ($trList.length) {
                        $.each($trList, function (index, value) {
                            let $tr = $(value);
                            $tr.find('input,select,textarea').each(function () {
                                let name = $(this).attr('name');
                                if (name) {
                                    let newName = name.replace(/\[\d+\]/, "[" + index + "]");
                                    $(this).attr("name", newName);
                                }
                            });

                            $tr.removeClass('TrOddChild');
                            $tr.removeClass('TrEvenChild');
                            $tr.addClass((index % 2 == 0 ? 'TrOddChild' : 'TrEvenChild'));
                        });
                    }
                    else {
                        $('#noData').removeClass('d-none');
                    }
                };

                swal({
                    text: '@(config.GetMessage("BeforeDeleteMsg").ToHtmlString())',
                    buttons: ['@(config.GetMessage("BtnCancel").ToHtmlString())', '@(config.GetMessage("BtnConfirm").ToHtmlString())'],
                    icon: 'info'
                }).then((result) => {
                    if (result) {
                        callDelete();
                    }
                });
            });
        $td0.append($btnDelete);
        $tr.append($td0);

        let $td1 = $('<td>');
        let $categoryId = $('<input>')
            .attr({
                type: 'hidden',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.CATEGORY_ID))`,
                value: valCATEGORY_ID
            });
        let $categoryName = $('<input>')
            .attr({
                type: 'hidden',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.CATEGORY_NAME))`,
                value: valCATEGORY_NAME
            });
        let $categoryNameDisplay = $('<span>')
            .html(valCATEGORY_NAME);
        $td1.append($categoryId);
        $td1.append($categoryName);
        $td1.append($categoryNameDisplay);
        $tr.append($td1);

        let $td2 = $('<td>');
        let $venderId = $('<input>')
            .attr({
                type: 'hidden',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.VENDER_ID))`,
                value: valVENDER_ID
            });
        let $venderNameDisplay = $('<span>')
            .html(valVENDER_NAME);
        $td2.append($venderId);
        $td2.append($venderNameDisplay);
        $tr.append($td2);

        let $td3 = $('<td>');
        let valItemNoteVal = valITEMNOTE.join(',');
        let $itemNoteVal = $('<input>')
            .attr({
                type: 'hidden',
                class: 'form-control',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.ItemNoteVal))`,
                value: valItemNoteVal
            });
        let $itemNoteValDisplay = $('<span>')
            .html(valItemNoteVal);
        let valItemDescVal = valITEMDESC.join(',');
        let $itemDescVal = $('<input>')
            .attr({
                type: 'hidden',
                class: 'form-control',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.ItemDescVal))`,
                value: valItemDescVal
            });
        let $itemDescValDisplay = $('<span>')
            .html(valItemDescVal);
        $td3.append($itemNoteVal);
        $td3.append($itemNoteValDisplay);
        $td3.append($('<br/>'));
        $td3.append($itemDescVal);
        $td3.append($itemDescValDisplay);
        $tr.append($td3);

        let $td4 = $('<td>');
        let $remark = $('<input>')
            .attr({
                type: 'hidden',
                class: 'form-control',
                name: `@(nameof(Model.TTItemList))[${idx}].@(nameof(NewOrderTTItemVM.REMARK))`,
                value: valREMARK
            });
        let $remarkDisplay = $('<span>')
            .html(valREMARK);
        $td4.append($remark);
        $td4.append($remarkDisplay);
        $tr.append($td4);

        $container.append($tr);

        context.TTItemList.count = idx + 1;
        $('#noData').addClass('d-none');
    });

    $('#@(Html.IdFor(m => m.TT_CATEGORY))').on('change.select2', function (e) {
        var $control = $(e.currentTarget);
        var data = $control.select2('data');

        if (data && data.length) {
            let selectedItem = data[0];
            if (selectedItem.text == '緊急(補單)') {
                swal({
                    text: '【除緊急故障發生，且已電話聯繫，廠商已到場處理者；否則請以「一般」報修處理】',
                    button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                    icon: 'warning',
                });
            }
        }
    });

    $('#@(DialogVenderModalId)').on('hidden.bs.modal', function (e) {
        let ctx = context['@(DialogVenderModalId)'];

        if (ctx.result && ctx.selectedItem) {
            let data = ctx.selectedItem;
            if ($('#SELFCONFIG').val() == 'N') {
                $('#@(Html.IdFor(m => m.TemplateItem.VENDER_ID))').val(data['id']);
                $('#@(Html.IdFor(m => m.TemplateItem.VENDER_NAME))').val(data['text']);
                $('#VENDER_NAME_DISPLAY').html(data['text']);
                $('#CP_NAME').html(data['OtherAttr']['CP_NAME']);
                $('#CP_TEL').html(data['OtherAttr']['CP_TEL']);
                $('#btnSelectVender').removeClass('d-none');
            }
        }
    });
</script>
