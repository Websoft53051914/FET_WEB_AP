@{
    // [Dispatch/Dispatch.asp]
    var mapData = new
    {
        IdModal = ViewData["DialogVenderModalId"],
        IdForm = Guid.NewGuid().ToString("N"),
        IdBtnOk = Guid.NewGuid().ToString("N"),
        IdSelectVender = Guid.NewGuid().ToString("N"),
    };
}

<div class="modal fade max100vh" id="@mapData.IdModal" tabindex="-1" role="dialog" aria-labelledby="@mapData.IdModal" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5>報修廠商</h5>
                <button class="btn-close" type="button" aria-label="Close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="@(mapData.IdForm)">
                    <div class="row gy-1">
                        <div class="col-12 col-md-6">
                            <label class="col-form-label websoft-form-label pt-0">廠商清單</label>
                            <select id="@(mapData.IdSelectVender)" class="form-select"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" type="button" id="@mapData.IdBtnOk">確認</button>
            </div>
        </div>
    </div>
</div>

<script>
    var context = context || {};

    $(document).ready(function () {
        if (!context['@(mapData.IdModal)']) {
            context['@(mapData.IdModal)'] = {};
        }

        var ctx = context['@(mapData.IdModal)'];
        ctx.result = '';
        ctx.selectedItem = null;

        $('#@(mapData.IdModal)').on('shown.bs.modal', function (e) {
            if (!ctx['IVRCODE'] || !ctx['CATEGORY_ID'] || !ctx['IFWARRANT']) {
                return;
            }

            ctx.SelectVender.reload();
        });

        ctx.SelectVender = {};
        ctx.SelectVender.init = function (dataSource) {
            dataSource = dataSource || [];
            let $control = $('#@(mapData.IdSelectVender)');
            $control.empty();
            $control.select2({
                data: dataSource,
            }).on('change.select2', function (e) {
                var $control = $(e.currentTarget);
                var data = $control.select2('data');

                if (data && data.length) {
                    ctx.selectedItem = data[0];
                }
                else {
                    ctx.selectedItem = null;
                }

                if (dataSource.length == 1) {
                    ctx.onlyOne = true;
                    $('#@(mapData.IdBtnOk)').click();
                }
            }).trigger('change');
        };
        ctx.SelectVender.reload = function () {
            ctx.onlyOne = false;
            var dataSource = [];
            let data = {
                cisid: ctx['CATEGORY_ID'],
                ivrCode: ctx['IVRCODE'],
                ifWarrant: ctx['IFWARRANT'],
            };

            showLoader();
            $.ajax({
                url: '@(Url.Action("GetSelectListVender", "NewOrder")?.ToHtmlString())',
                dataType: 'json',
                type: 'POST',
                data: data,
                cache: false
            })
                .done((response) => {
                    if (response.Success) {
                        dataSource = $.map(response.Data, (val, idx) => {
                            return $.extend(val, {
                                id: val['@(nameof(SelectListItem.Value))'],
                                text: val['@(nameof(SelectListItem.Text))'],
                                OtherAttr: val['@(nameof(SelectListItemCustom.OtherAttr))'],
                            });
                        });
                    }
                    else {
                        swal({
                            text: response['Message'],
                            button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                            icon: 'error'
                        }).then(() => {

                        });
                    }
                })
                .fail((err) => {
                    console.log(err);
                })
                .always(() => {
                    hideLoader();
                    ctx.SelectVender.init(dataSource);
                });
        }

        $("#@mapData.IdBtnOk").on("click", function () {
            if (ctx.selectedItem) {
                ctx.result = '1';
                $('#@mapData.IdModal').modal('hide'); // 關閉模態框
            }
            else {
                swal({
                    text: '請選擇廠商！',
                    button: '@(config.GetMessage("BtnConfirm").ToHtmlString())',
                    icon: 'warning'
                });
            }
        });
    });
</script>