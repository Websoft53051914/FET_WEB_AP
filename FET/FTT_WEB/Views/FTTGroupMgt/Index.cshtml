@{
    var FTT_GroupList = ViewData["FTT_GroupList"] as List<SelectListItem>;


    var mapText = new
    {
        Btn_Search = "查詢",
        Btn_Clear = "清除",
        Btn_Create = "新增",
        Btn_Confirm = "確認",
        Btn_Cancel = "取消",
    };

    var mapUrl = new
    {
        Delete = Url.Action("Delete"),
    };

    var mapAttr = new
    {
        IdBtnSearch = Guid.NewGuid(),
        IdGrid = Guid.NewGuid(),
    };
}

<div class="container-fluid">
    <div class="page-header" style="padding-bottom:20px">
        <div class="row">
            <div class="col-sm-6">
                <h3>角色權限維護</h3>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/Home" data-bs-original-title="" title="">首頁</a></li>
                    <li class="breadcrumb-item">後端功能</li>
                    <li class="breadcrumb-item active"><a href="" data-bs-original-title="" title="">角色權限維護</a></li>
                </ol>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">

    <div class="card mb-2">
        <div class="card-body">
            <div class="row gy-3 mb-3">
                <div class="col-xl-3 col-lg-4 col-sm-6 col-12">
                    <label class="col-form-label pt-0">員工編號</label>
                    <input type="text" class="form-control" placeholder="" id="EmpNo" name="EmpNo">
                </div>
                <div class="col-xl-3 col-lg-4 col-sm-6 col-12">
                    <label class="col-form-label pt-0">角色</label>
                    <select id="FTT_Group" name="FTT_Group">
                        @foreach (var item in FTT_GroupList)
                        {
                            <option value="@(item.Value)">@item.Text</option>
                        }
                    </select>
                </div>
            </div>
            <button class="btn btn-primary" id="btnAdd">新增</button>
        </div>
    </div>

    <div class="card mb-2">
        <div class="card-body py-3 card-body-reduction">
            <div class="row  mb-2">
                <div class="col-xl-3 col-lg-4 col-sm-6 col-12">
                    <label class="col-form-label websoft-form-label pt-2">中文姓名</label>
                    <input type="text" class="form-control" placeholder="" id="CName" name="CName">
                </div>
            </div>
            <button class="btn btn-primary" id="@(mapAttr.IdBtnSearch)">送出查詢</button>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div id="@(mapAttr.IdGrid)"></div>
            <div class="d-block d-md-flex justify-content-md-end align-items-center pagination">
                <div id="pageResizer" class="jsgrid-pager-page">
                    <span>每頁筆數:</span>
                    <select id="pageSelect">
                    </select>
                </div>
                <div id="pagers">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="CreateModal" class="modal fade" data-bs-backdrop="static" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header text-center">
                <h5 class="modal-title w-100 text-center">"新增"</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row gy-3 mb-3">
                    <div class="col-md-6 col-12">
                        <label class="col-form-label pt-0">員工編號</label>
                        <input id="EmpNo" name="EmpNo" class="form-control" readonly />
                    </div>
                    <div class="col-md-6 col-12">
                        <label class="col-form-label pt-0">角色</label>
                        <select id="FTT_Group" name="FTT_Group">
                            @foreach (var item in FTT_GroupList)
                            {
                                <option value="@(item.Value)">@item.Text</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script>

        const context = {
            $Grid: $("#@(mapAttr.IdGrid)"),
        };

        $(function () {
            initGrid(1);

            $("#pageSelect").on("change", function () {
                const val = this.value;
                onPageLenghtSelect(val, context.$Grid);
            })

            $("#pageSelect").select2({
                minimumResultsForSearch: -1,
                data: pageDataSource
            });
            $("#pageSelect").data("select2").$container.addClass("w-auto");

            $('.initDatepicker').datetimepicker({
                format: 'YYYY/MM/DD',
            });

            $(".select2-Clear").select2({
                placeholder: "請選擇",
                allowClear: true,
            });

            $("#FTT_Group").select2({
            });

            $('#@(mapAttr.IdBtnSearch)').on('click', (e) => {

                context.$Grid.jsGrid('search');
            });

            $("#btnAdd").on("click", function () {
                showLoader();

                if ($('EmpNo').val() == '') {
                    hideLoader();

                    swal({
                        text: '請輸入員工編號!!',
                        icon: "warring",
                        button: "@mapText.Btn_Confirm.ToHtmlString()"
                    });
                    return;
                }
                else {
                    var FTT_Group = $('#FTT_Group').val();
                    var EmpNo = $('#EmpNo').val();

                    var vm = {
                        EmpNo: EmpNo,
                        FTT_Group: FTT_Group,
                    };

                    $.ajax({
                        type: "POST",
                        url: "@Url.Action("Create")",
                        data: vm,
                        dataType: "json",
                        success: function (res) {
                            var alertType = res.Success ? "success" : "error";

                            hideLoader();

                            if (res.Success === false) {
                                swal({
                                    text: res.Message,
                                    icon: alertType,
                                    button: "@mapText.Btn_Confirm.ToHtmlString()"
                                });
                            } else {
                                swal({
                                    text: res.Data,
                                    icon: alertType,
                                    button: "@mapText.Btn_Confirm.ToHtmlString()"
                                }).then((result) => {
                                    context.$Grid.jsGrid('search');
                                });
                            }
                        }
                    })
                }
            })
        });

        function initGrid(cookiePageIndex) {
            $("#@(mapAttr.IdGrid)").jsGrid({
                pageIndex: cookiePageIndex,
                paging: true,
                width: "100%",
                pageSize: pageDataSource[0].id,
                pageButtonCount: 5,
                pagerFormat: "{first} {prev} {pages} {next} {last}    第 {pageIndex} 頁 共 {pageCount} 頁",
                pagePrevText: "上一頁",
                pageNextText: "下一頁",
                pageFirstText: "第一頁",
                pageLastText: "最後一頁",
                pageLoading: true,
                autoload: true,
                changePageSize: function (pageSize) {
                    var $this = this;
                    $this.pageSize = pageSize;

                    context.$Grid.jsGrid("openPage", 1);
                },
                pagerContainer: "#pagers",
                onDataLoaded: function () {
                    feather.replace();
                },
                controller: {
                    loadData: function (filter) {
                        var d = $.Deferred();
                        var CName = $('#CName').val();
                        filter.vm = {
                            CName: CName,
                        };
                        $.ajax({
                            type: "POST",
                            url: "@Url.Action("GetPageList")",
                            data: filter,
                            dataType: "json",
                            success: function (res) {
                                if (res.Success === false) {
                                    swal({
                                        text: res.Message,
                                        icon: "error",
                                        button: "確認"
                                    });
                                    d.reject();
                                    return;
                                }
                                var da = {
                                    data: res.Data,
                                    itemsCount: res.Total
                                }
                                d.resolve(da);
                            }
                        })

                        return d.promise();
                    }
                },
                fields: [
                    { name: "Id", visible: false },
                    {
                        type: 'control', align: "center",
                        width: 80,
                        editButton: false,
                        deleteButton: false,
                        headerTemplate: (value, item) => {
                            return $("<div>操作<div>").attr({ class: '' });
                        },
                        itemTemplate: (value, item) => {

                            $div = $('<div>')

                            $deleteButton = $('<button>')
                                .attr({
                                    'class': 'exclick jsgrid-button jsgrid-delete-button',
                                })
                                .on('click', () => {
                                    const callDelete = () => {
                                        var data = {
                                            empNo: item['EmpNo']
                                        };

                                        $.ajax({
                                            url: '@(mapUrl.Delete.ToHtmlString())',
                                            dataType: 'json',
                                            type: 'POST',
                                            data: data
                                        })
                                            .done((response) => {
                                                var msg = response.Success ? response.Data : response.Message;
                                                var alertType = response.Success ? "success" : "error";

                                                swal({
                                                    text: msg,
                                                    button: '@(mapText.Btn_Confirm.ToHtmlString())',
                                                    icon: alertType
                                                }).then((result) => {
                                                    if (result) {
                                                        context.$Grid.jsGrid('search');
                                                    }
                                                });
                                            });
                                    }

                                    swal({
                                        text: `@config.GetMessage("BeforeDeleteMsg").ToHtmlString()`,
                                        buttons: ['@(mapText.Btn_Cancel.ToHtmlString())', '@(mapText.Btn_Confirm.ToHtmlString())'],
                                        icon: "info"
                                    }).then((result) => {
                                        console.log(result);
                                        if (result) {
                                            callDelete();
                                        }
                                    });
                                });



                            var result = $div.append($deleteButton);
                            return result;
                        }
                    },
                    // 1.員工編號 EmpNo 2.角色 FTT_Group 3.中文姓名 CName 4.英文姓名 EName 5.分機Ext
                    { name: "EmpNo", title: "員工編號", type: "text", width: 150, align: "center" },
                    { name: "FTT_Group", title: "角色", type: "text", width: 140, align: "center" },
                    { name: "CName", title: "中文姓名", type: "text", width: 150, align: "center" },
                    { name: "EName", title: "英文姓名", type: "text", width: 160, align: "center" },
                    { name: "Ext", title: "分機Ext", type: "text", width: 150, align: "center" },
                    {
                        width: 'auto'
                    }
                ],

            });

            //分頁頁數紀錄相關
            context.$Grid.jsGrid('_setPage', cookiePageIndex);//jsgrid bug 不會自動將頁碼設定成pageindex
        }

    </script>
}
